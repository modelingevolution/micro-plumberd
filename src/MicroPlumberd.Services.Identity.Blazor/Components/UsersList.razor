@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Identity.UI.Services
@using Microsoft.Extensions.DependencyInjection
@using ModelingEvolution.Observable.Blazor
@inject UserManager<User> UserManager
@inject RoleManager<Role> RoleManager
@inject UsersModel UsersModel
@inject RolesModel RolesModel
@inject IDialogService DialogService
@inject IServiceProvider ServiceProvider

<MudStack Spacing="4">
    <MudStack Row="true" Spacing="2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.PersonAdd" OnClick="ShowAddUserDialog">
            Add User
        </MudButton>
    </MudStack>

    @if (!UsersModel.Items.Any())
    {
        <MudAlert Severity="Severity.Info">No users found.</MudAlert>
    }
    else
    {
        <MudTable Items="@UsersModel.Items" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>Email</MudTh>
                <MudTh>Username</MudTh>
                <MudTh>Email Confirmed</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Username">@context.UserName</MudTd>
                <MudTd DataLabel="Email Confirmed">
                    @if (context.EmailConfirmed)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" />
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    @if (!context.EmailConfirmed)
                    {
                        <MudTooltip Text="Confirm Email">
                            <MudIconButton Icon="@Icons.Material.Filled.MarkEmailRead" Size="Size.Small" Color="Color.Default"
                                           OnClick="() => ConfirmEmail(context)" />
                        </MudTooltip>
                    }
                    <MudTooltip Text="Manage Roles">
                        <MudIconButton Icon="@Icons.Material.Filled.Security" Size="Size.Small" Color="Color.Default"
                                       OnClick="() => ShowRolesDialog(context)" />
                    </MudTooltip>
                    <MudTooltip Text="Reset Password">
                        <MudIconButton Icon="@Icons.Material.Filled.Password" Size="Size.Small" Color="Color.Default"
                                       OnClick="() => ShowResetPasswordDialog(context)" />
                    </MudTooltip>
                    <MudTooltip Text="Delete User">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Default"
                                       OnClick="() => ShowDeleteDialog(context)" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudStack>

@code {
    [Parameter]
    public EventCallback OnUserChanged { get; set; }

    private bool _isEmailSenderConfigured;
    private IEmailSender? _emailSender;

    protected override void OnInitialized()
    {
        _emailSender = ServiceProvider.GetService<IEmailSender>();
        if (_emailSender != null)
        {
            var emailSenderType = _emailSender.GetType();
            _isEmailSenderConfigured = !emailSenderType.Name.Contains("NoOp", StringComparison.OrdinalIgnoreCase);
        }
    }

    private async Task ShowAddUserDialog()
    {
        var availableRoles = RolesModel.Items.Select(r => r.Name!).ToList();
        var parameters = new DialogParameters<AddUserDialog>
        {
            { x => x.UserManager, UserManager },
            { x => x.EmailSender, _emailSender },
            { x => x.AvailableRoles, availableRoles },
            { x => x.IsEmailSenderConfigured, _isEmailSenderConfigured }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<AddUserDialog>("Add User", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await OnUserChanged.InvokeAsync();
        }
    }

    private async Task ShowRolesDialog(User user)
    {
        var availableRoles = RolesModel.Items.Select(r => r.Name!).ToList();
        var currentRoles = await UserManager.GetRolesAsync(user);
        var parameters = new DialogParameters<ManageUserRolesDialog>
        {
            { x => x.UserManager, UserManager },
            { x => x.User, user },
            { x => x.AvailableRoles, availableRoles },
            { x => x.CurrentRoles, currentRoles }
        };

        var dialog = await DialogService.ShowAsync<ManageUserRolesDialog>($"Manage Roles for {user.Email}", parameters);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await OnUserChanged.InvokeAsync();
        }
    }

    private async Task ShowResetPasswordDialog(User user)
    {
        var parameters = new DialogParameters<ResetPasswordDialog>
        {
            { x => x.UserManager, UserManager },
            { x => x.User, user }
        };

        var dialog = await DialogService.ShowAsync<ResetPasswordDialog>($"Reset Password for {user.Email}", parameters);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await OnUserChanged.InvokeAsync();
        }
    }

    private async Task ShowDeleteDialog(User user)
    {
        var parameters = new DialogParameters<DeleteUserDialog>
        {
            { x => x.UserManager, UserManager },
            { x => x.User, user }
        };

        var dialog = await DialogService.ShowAsync<DeleteUserDialog>("Delete User", parameters);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            await OnUserChanged.InvokeAsync();
        }
    }

    private async Task ConfirmEmail(User user)
    {
        var token = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        var result = await UserManager.ConfirmEmailAsync(user, token);
        if (result.Succeeded)
        {
            await OnUserChanged.InvokeAsync();
        }
    }
}
